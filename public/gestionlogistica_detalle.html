<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Detalle Log√≠stico ¬∑ Extranet Hidrospa</title>
    <link rel="stylesheet" href="/style.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body class="gestion-logistica">
<p style="text-align:center; margin-bottom: 20px;">
    <a href="/gestionlogistica.html">‚Üê Volver</a>
</p>

<div class="detalle-card" id="detalle">Cargando...</div>

<!-- MODAL -->
<div id="modalEditar" class="modal hidden">
    <div class="modal-content wide">
        <h3>Editar despacho</h3>

        <div class="tabs">
            <button class="tab active" data-tab="cliente">Cliente</button>
            <button class="tab" data-tab="logistica">Log√≠stica</button>
            <button class="tab" data-tab="transporte">Transporte</button>
            <button class="tab" data-tab="observaciones">Observaciones</button>
        </div>

        <form id="formEditar" class="tab-content">
            <!-- CLIENTE -->
            <div class="tab-panel active" id="tab-cliente">
                <label>Cliente</label>
                <input name="cliente" type="text"/>

                <label>Comercial</label>
                <input name="comercial" type="text"/>

                <label>Rem/Req</label>
                <input name="rem_req" type="text"/>

                <label>Producto</label>
                <input name="producto" type="text"/>

                <label>Adicionales</label>
                <input name="adicionales" type="text"/>
            </div>

            <!-- LOG√çSTICA -->
            <div class="tab-panel" id="tab-logistica">
                <label>Fecha de Cargue</label>
                <input name="fecha_cargue" type="date"/>

                <label>Fecha de Entrega</label>
                <input name="fecha_entrega" type="date"/>

                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:8px;">
                    <label><input type="checkbox" name="confirmacion"> Confirmaci√≥n</label>
                    <label><input type="checkbox" name="pago_100"> Pago 100%</label>
                    <label><input type="checkbox" name="reprogramado"> Reprogramado</label>
                    <label><input type="checkbox" name="entregas_a_tiempo"> Entrega a tiempo</label>
                </div>

                <label style="margin-top:10px;">Fecha l√≠mite asesor√≠a</label>
                <input name="fecha_limite_asesoria" type="date"/>

                <label>Fecha programaci√≥n asesor√≠a</label>
                <input name="fecha_programacion_asesoria" type="date"/>
            </div>

            <!-- TRANSPORTE -->
            <div class="tab-panel" id="tab-transporte">
                <label>Transportador</label>
                <input name="transportador" type="text"/>

                <label>Direcci√≥n env√≠o</label>
                <textarea name="direccion_envio"></textarea>

                <label>Costo del flete</label>
                <input name="costo_flete" type="number" step="0.01"/>
            </div>

            <!-- OBSERVACIONES -->
            <div class="tab-panel" id="tab-observaciones">
                <label>Observaciones</label>
                <textarea name="observaciones"></textarea>

                <label>Comentarios</label>
                <textarea name="comentarios"></textarea>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn-save">Guardar cambios</button>
            </div>
        </form>
    </div>
</div>

<div class="acciones">
    <button class="btn-edit" id="btnEditar">‚úèÔ∏è Editar</button>
    <button class="btn-done" id="btnEntregar">‚úÖ Marcar como entregado</button>
    <button class="btn-cancel" id="btnReprogramar">üîÑ Reprogramar</button>
    <button class="btn-delete" id="btnEliminar">üóë Eliminar</button>
</div>

<script>
    if (!localStorage.getItem('token')) location.href = '/index.html';

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    let despacho = null;

    // ===== Helpers de normalizaci√≥n =====
    const emptyToNull = v => (v === '' || v === undefined) ? null : v;
    const toBool = v => (v === true || v === 'true' || v === 'on');
    const toISO = v => v ? v : null; // ya viene YYYY-MM-DD del input date
    const toNumber = v => (v === '' || v === null || v === undefined) ? null : Number(v);

    // ===== Cargar detalle =====
    fetch('/api/cronograma?id=' + id, {
        headers: { "Authorization": "Bearer " + localStorage.getItem('token') }
    })
        .then(r => r.json())
        .then(data => {
            despacho = data;
            const f = x => x ? x.substring(0,10) : '';
            document.getElementById('detalle').innerHTML = `
    <h3>${data.cliente ?? ''}</h3>
    <div class="grid-detail">
      <div>
        <p><strong>Comercial:</strong> ${data.comercial ?? ''}</p>
        <p><strong>Rem/Req:</strong> ${data.rem_req ?? ''}</p>
        <p><strong>Producto:</strong> ${data.producto ?? ''}</p>
        <p><strong>Adicionales:</strong> ${data.adicionales ?? ''}</p>
      </div>
      <div>
        <p><strong>Fecha cargue:</strong> ${f(data.fecha_cargue)}</p>
        <p><strong>Fecha entrega:</strong> ${f(data.fecha_entrega)}</p>
        <p><strong>Pago 100%:</strong> ${data.pago_100 ? 'S√≠' : 'No'}</p>
        <p><strong>Reprogramado:</strong> ${data.reprogramado ? 'S√≠' : 'No'}</p>
      </div>
      <div>
        <p><strong>Direcci√≥n de env√≠o:</strong><br>${data.direccion_envio ?? ''}</p>
        <p><strong>Transportador:</strong> ${data.transportador ?? ''}</p>
        <p><strong>Costo del flete:</strong> ${data.costo_flete ?? ''}</p>
      </div>
      <div>
        <p><strong>Observaciones:</strong><br>${data.observaciones ?? ''}</p>
        <p><strong>Comentarios:</strong><br>${data.comentarios ?? ''}</p>
        <p><strong>Entregas a tiempo:</strong> ${data.entregas_a_tiempo ? 'S√≠' : 'No'}</p>
      </div>
    </div>`;
        });

    // ===== Modal =====
    function abrirModal() {
        if (!despacho) return;

        const form = document.getElementById('formEditar');

        // Prellenar b√°sicos tipo texto/textarea
        ['cliente','comercial','rem_req','producto','adicionales','transportador','direccion_envio','observaciones','comentarios']
            .forEach(name => {
                const el = form.querySelector(`[name="${name}"]`);
                if (el) el.value = despacho[name] ?? '';
            });

        // Fechas
        ['fecha_cargue','fecha_entrega','fecha_limite_asesoria','fecha_programacion_asesoria']
            .forEach(name => {
                const el = form.querySelector(`[name="${name}"]`);
                if (el) el.value = despacho[name] ? despacho[name].substring(0,10) : '';
            });

        // N√∫meros
        const cf = form.querySelector('[name="costo_flete"]');
        if (cf) cf.value = despacho.costo_flete ?? '';

        // Booleanos (checkbox)
        form.querySelector('[name="confirmacion"]').checked = !!despacho.confirmacion;
        form.querySelector('[name="pago_100"]').checked = !!despacho.pago_100;
        form.querySelector('[name="reprogramado"]').checked = !!despacho.reprogramado;
        form.querySelector('[name="entregas_a_tiempo"]').checked = !!despacho.entregas_a_tiempo;

        document.getElementById('modalEditar').classList.remove('hidden');
    }
    function cerrarModal(){ document.getElementById('modalEditar').classList.add('hidden'); }
    document.getElementById('btnEditar').onclick = abrirModal;

    // ===== Guardar cambios (PUT) =====
    document.getElementById("formEditar").onsubmit = async (e) => {
        e.preventDefault();
        const form = e.target;

        const payload = {
            // Cliente
            cliente: emptyToNull(form.cliente.value),
            comercial: emptyToNull(form.comercial.value),
            rem_req: emptyToNull(form.rem_req.value),
            producto: emptyToNull(form.producto.value),
            adicionales: emptyToNull(form.adicionales.value),

            // Log√≠stica
            fecha_cargue: toISO(form.fecha_cargue.value),
            fecha_entrega: toISO(form.fecha_entrega.value),
            confirmacion: toBool(form.confirmacion.checked),
            reprogramado: toBool(form.reprogramado.checked),
            pago_100: toBool(form.pago_100.checked),
            fecha_limite_asesoria: toISO(form.fecha_limite_asesoria.value),
            fecha_programacion_asesoria: toISO(form.fecha_programacion_asesoria.value),

            // Transporte
            transportador: emptyToNull(form.transportador.value),
            direccion_envio: emptyToNull(form.direccion_envio.value),
            costo_flete: toNumber(form.costo_flete.value),

            // Observaciones
            observaciones: emptyToNull(form.observaciones.value),
            comentarios: emptyToNull(form.comentarios.value),
            entregas_a_tiempo: toBool(form.entregas_a_tiempo.checked),
        };

        const resp = await fetch("/api/cronograma/" + id, {
            method:"PUT",
            headers:{
                "Content-Type":"application/json",
                "Authorization":"Bearer " + localStorage.getItem('token')
            },
            body: JSON.stringify(payload)
        });

        if (!resp.ok) {
            const t = await resp.text().catch(()=> '');
            alert("‚ùå Error guardando: " + t);
            return;
        }

        alert("‚úÖ Cambios guardados");
        location.reload();
    };

    // ===== Tabs =====
    document.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
            document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));

            btn.classList.add("active");
            document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
        });
    });
</script>

</body>
</html>
