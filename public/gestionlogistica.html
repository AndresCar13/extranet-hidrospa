<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Gestión logística</title>
    <link rel="stylesheet" href="/style.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body class="gestion-logistica">
<h2>Gestión logística</h2>
<p style="text-align:center;"><a href="/dashboard.html">← Volver</a></p>

<div class="filters-wrapper">
    <div class="filters-box">
        <div style="display:flex; flex-direction:column;">
            <label>Comercial</label>
            <select id="filterComercial">
                <option value="">Todos</option>
            </select>
        </div>

        <div style="display:flex; flex-direction:column;">
            <label>Fecha cargue (desde)</label>
            <input type="date" id="filterFechaCargueInicio">
        </div>

        <div style="display:flex; flex-direction:column;">
            <label>Fecha cargue (hasta)</label>
            <input type="date" id="filterFechaCargueFin">
        </div>

        <div style="display:flex; flex-direction:column;">
            <label>Fecha entrega (desde)</label>
            <input type="date" id="filterFechaEntregaInicio">
        </div>

        <div style="display:flex; flex-direction:column;">
            <label>Fecha entrega (hasta)</label>
            <input type="date" id="filterFechaEntregaFin">
        </div>

        <div style="display:flex; flex-direction:column; flex:1;">
            <label>Búsqueda general</label>
            <input type="text" id="filterBusqueda" placeholder="Cliente, producto, dirección...">
        </div>

        <button id="btnBuscar">Buscar</button>
    </div>
</div>

<div class="table-container">
    <table id="tablaCronograma">
        <thead>
        <tr>
            <th>ID</th>
            <th>Comercial</th>
            <th>Rem/Req</th>
            <th>Cliente</th>
            <th>Producto</th>
            <th>Adicionales</th>
            <th class="sortable" data-col="fecha_cargue">Fecha cargue</th>
            <th class="sortable" data-col="fecha_entrega">Fecha entrega</th>
            <th>Transportador</th>
            <th>Dirección envío</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    if (!localStorage.getItem('token')) location.href = '/index.html';

    let cronograma = [];

    // ===== Utilidades de fechas (LOCAL, sin UTC) =====
    const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
    const pad2 = n => String(n).padStart(2, '0');

    function parseLocalDate(iso) {
        if (!iso) return null;
        const [y, m, d] = iso.substring(0, 10).split('-').map(Number);
        return new Date(y, (m || 1) - 1, d || 1); // Fecha local (medianoche local)
    }

    function startOfWeekMonday(date) {
        // Clonar y normalizar a fecha local
        const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const day = d.getDay(); // 0=Dom ... 1=Lun ... 6=Sáb
        const diff = (day === 0 ? -6 : 1 - day); // mover al Lunes
        const monday = new Date(d);
        monday.setDate(d.getDate() + diff);
        return monday;
    }

    function endOfWeekSaturday(monday) {
        const saturday = new Date(monday);
        saturday.setDate(monday.getDate() + 5);
        return saturday;
    }

    function weekKeyFromDate(date) {
        const monday = startOfWeekMonday(date);
        // clave estable local YYYY-MM-DD del LUNES
        return `${monday.getFullYear()}-${pad2(monday.getMonth() + 1)}-${pad2(monday.getDate())}`;
    }

    function weekRangeTextFromDate(date) {
        const monday = startOfWeekMonday(date);
        const saturday = endOfWeekSaturday(monday);
        const inicio = `${monday.getDate()} ${meses[monday.getMonth()]}`;
        const fin = `${saturday.getDate()} ${meses[saturday.getMonth()]}`;
        return `${inicio} al ${fin}`;
    }

    // ================= FILTROS (persistencia) =================
    const FILTER_KEYS = [
        'filtroComercial', 'filtroCargueIni', 'filtroCargueFin',
        'filtroEntregaIni', 'filtroEntregaFin', 'filtroBusqueda'
    ];

    function clearSessionFilters() {
        FILTER_KEYS.forEach(k => sessionStorage.removeItem(k));
    }

    function haveAnyFilter() {
        return FILTER_KEYS.some(k => (sessionStorage.getItem(k) ?? '') !== '');
    }

    function restoreSessionFilters() {
        document.getElementById('filterComercial').value = sessionStorage.getItem('filtroComercial') ?? '';
        document.getElementById('filterFechaCargueInicio').value = sessionStorage.getItem('filtroCargueIni') ?? '';
        document.getElementById('filterFechaCargueFin').value = sessionStorage.getItem('filtroCargueFin') ?? '';
        document.getElementById('filterFechaEntregaInicio').value = sessionStorage.getItem('filtroEntregaIni') ?? '';
        document.getElementById('filterFechaEntregaFin').value = sessionStorage.getItem('filtroEntregaFin') ?? '';
        document.getElementById('filterBusqueda').value = sessionStorage.getItem('filtroBusqueda') ?? '';
    }

    // ================= CARGA INICIAL =================
    fetch('/api/cronograma', {
        headers: {"Authorization": "Bearer " + localStorage.getItem('token')}
    })
        .then(r => r.json())
        .then(data => {
            cronograma = data;

            const keep = sessionStorage.getItem('keepFilters') === '1';
            if (!keep) clearSessionFilters();
            else sessionStorage.removeItem('keepFilters');

            cargarComerciales(data);
            restoreSessionFilters();
            if (haveAnyFilter()) {
                aplicarFiltros();
            } else {
                // No mostrar nada hasta que el usuario presione "Buscar"
                const tbody = document.querySelector('#tablaCronograma tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align:center; color:#666; padding:20px;">
                            Use los filtros superiores y presione <b>Buscar</b> para visualizar la programación logística.
                        </td>
                    </tr>`;
            }

        });

    function cargarComerciales(data) {
        const select = document.getElementById('filterComercial');
        select.innerHTML = '<option value="">Todos</option>';
        const comerciales = [...new Set(data.map(x => x.comercial).filter(Boolean))].sort();
        comerciales.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            select.appendChild(opt);
        });
    }

    // ================= ORDENAMIENTO =================
    let sortColumn = null;
    let sortDirection = null;

    document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const col = th.dataset.col;
            if (sortColumn === col)
                sortDirection = sortDirection === 'asc' ? 'desc' : sortDirection === 'desc' ? null : 'asc';
            else {
                sortColumn = col;
                sortDirection = 'asc';
            }
            aplicarFiltros();
            actualizarIconosOrden();
        });
    });

    function actualizarIconosOrden() {
        document.querySelectorAll('.sortable').forEach(th => th.classList.remove('asc', 'desc'));
        if (sortDirection) {
            const active = document.querySelector(`.sortable[data-col="${sortColumn}"]`);
            active.classList.add(sortDirection);
        }
    }

    // ================= RENDER TABLA (agrupa por semana de fecha_cargue) =================
    function mostrarTabla(data) {
        const tbody = document.querySelector('#tablaCronograma tbody');
        tbody.innerHTML = "";
        if (!data.length) return;

        // Ordenar por fecha cargue local
        data.sort((a, b) => {
            const f1 = parseLocalDate(a.fecha_cargue) || new Date(1900, 0, 1);
            const f2 = parseLocalDate(b.fecha_cargue) || new Date(1900, 0, 1);
            return f1 - f2;
        });

        // Agrupar por semana
        const semanas = new Map();
        data.forEach(row => {
            const fecha = parseLocalDate(row.fecha_cargue);
            if (!fecha) return;
            const key = weekKeyFromDate(fecha);
            if (!semanas.has(key)) semanas.set(key, []);
            semanas.get(key).push(row);
        });

        // Calcular desde la semana más antigua a la más reciente
        const todasLasFechas = data.map(x => parseLocalDate(x.fecha_cargue)).filter(Boolean);
        const fechaMin = new Date(Math.min(...todasLasFechas));
        const fechaMax = new Date(Math.max(...todasLasFechas));

        // Iterar semana por semana (lunes a sábado)
        for (let d = startOfWeekMonday(fechaMin); d <= fechaMax; d.setDate(d.getDate() + 7)) {
            const key = weekKeyFromDate(d);
            const rango = weekRangeTextFromDate(d);
            const rows = semanas.get(key);

            // Separador de semana
            tbody.innerHTML += `
            <tr class="week-separator">
                <td colspan="10">${rango.toUpperCase()}</td>
            </tr>`;

            // Si no hay despachos en esta semana → fila especial
            if (!rows || !rows.length) {
                tbody.innerHTML += `
                <tr style="background:#f5f5f5; color:#333; text-align:center;">
                    <td colspan="10"><b>NO SALIERON DESPACHOS ESTA SEMANA</b></td>
                </tr>`;
                continue;
            }

            // Si hay despachos → mostrar filas normales
            rows.forEach(row => {
                const fechaCargueStr = row.fecha_cargue ? row.fecha_cargue.substring(0, 10) : '';
                const fechaEntregaStr = row.fecha_entrega ? row.fecha_entrega.substring(0, 10) : '';

                tbody.innerHTML += `
                <tr onclick="goDetalle(${row.id})" style="cursor:pointer;">
                    <td>${row.id}</td>
                    <td>${row.comercial ?? ''}</td>
                    <td>${row.rem_req ?? ''}</td>
                    <td>${row.cliente ?? ''}</td>
                    <td>${row.producto ?? ''}</td>
                    <td>${row.adicionales ?? ''}</td>
                    <td>${fechaCargueStr}</td>
                    <td>${fechaEntregaStr}</td>
                    <td>${row.transportador ?? ''}</td>
                    <td>${row.direccion_envio ?? ''}</td>
                </tr>`;
            });
        }
    }


    // ================= NAVEGACIÓN =================
    function goDetalle(id) {
        sessionStorage.setItem('keepFilters', '1');
        window.location.href = '/gestionlogistica_detalle.html?id=' + id;
    }

    // ================= APLICAR FILTROS =================
    document.getElementById('btnBuscar').addEventListener('click', aplicarFiltros);

    function aplicarFiltros() {
        // guardar
        sessionStorage.setItem('filtroComercial', document.getElementById('filterComercial').value);
        sessionStorage.setItem('filtroCargueIni', document.getElementById('filterFechaCargueInicio').value);
        sessionStorage.setItem('filtroCargueFin', document.getElementById('filterFechaCargueFin').value);
        sessionStorage.setItem('filtroEntregaIni', document.getElementById('filterFechaEntregaInicio').value);
        sessionStorage.setItem('filtroEntregaFin', document.getElementById('filterFechaEntregaFin').value);
        sessionStorage.setItem('filtroBusqueda', document.getElementById('filterBusqueda').value);

        let data = [...cronograma];

        const comercial = document.getElementById('filterComercial').value;
        const buscador = (document.getElementById('filterBusqueda').value || '').toLowerCase();

        const fcIni = parseLocalDate(document.getElementById('filterFechaCargueInicio').value);
        const fcFin = parseLocalDate(document.getElementById('filterFechaCargueFin').value);
        const feIni = parseLocalDate(document.getElementById('filterFechaEntregaInicio').value);
        const feFin = parseLocalDate(document.getElementById('filterFechaEntregaFin').value);

        if (comercial) data = data.filter(x => x.comercial === comercial);

        if (buscador) {
            data = data.filter(x =>
                (x.cliente ?? '').toLowerCase().includes(buscador) ||
                (x.producto ?? '').toLowerCase().includes(buscador) ||
                (x.direccion_envio ?? '').toLowerCase().includes(buscador)
            );
        }

        // Rango por fecha_cargue (LOCAL)
        if (fcIni) data = data.filter(x => {
            const f = parseLocalDate(x.fecha_cargue);
            return f && f >= fcIni;
        });
        if (fcFin) data = data.filter(x => {
            const f = parseLocalDate(x.fecha_cargue);
            return f && f <= fcFin;
        });

        // Rango por fecha_entrega (opcional)
        if (feIni) data = data.filter(x => {
            const f = parseLocalDate(x.fecha_entrega);
            return f && f >= feIni;
        });
        if (feFin) data = data.filter(x => {
            const f = parseLocalDate(x.fecha_entrega);
            return f && f <= feFin;
        });

        // Ordenamiento por columna (si lo activaste)
        if (sortColumn && sortDirection) {
            data.sort((a, b) => {
                if (sortColumn === 'fecha_cargue' || sortColumn === 'fecha_entrega') {
                    const d1 = parseLocalDate(a[sortColumn]) || new Date(1900, 0, 1);
                    const d2 = parseLocalDate(b[sortColumn]) || new Date(1900, 0, 1);
                    return sortDirection === 'asc' ? d1 - d2 : d2 - d1;
                } else {
                    const v1 = (a[sortColumn] ?? '').toString().toLowerCase();
                    const v2 = (b[sortColumn] ?? '').toString().toLowerCase();
                    if (v1 < v2) return sortDirection === 'asc' ? -1 : 1;
                    if (v1 > v2) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                }
            });
        }

        mostrarTabla(data);
    }
</script>

</body>
</html>
